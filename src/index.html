<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="./d3.css"/>
<style>
    .background {
        fill: #eee;
        pointer-events: all;
    }

    .map-layer {
        fill: #fff;
        stroke: #aaa;
    }

    .effect-layer {
        pointer-events: none;
    }

    text {
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        font-weight: 300;
    }

    text.big-text {
        font-size: 30px;
        font-weight: 400;
    }

    .effect-layer text,
    text.dummy-text {
        font-size: 12px;
    }
</style>

<body>
<h1>Welcome to ATL Uber Data Analysis</h1>
<h2>Team 28 TeamNoName</h2>
<h3>Zhekun Qi, Yiqiong Xiao, Shuting Lin, Xiang Zhong, Jie Zhou</h3>

<div id="slider1"></div>
<svg></svg>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>
<script src="./d3.slider.js"></script>
<script src="https://d3js.org/d3-time.v1.min.js"></script>
<script src="https://d3js.org/d3-time-format.v2.min.js"></script>
<script src="https://unpkg.com/d3-simple-slider"></script>

<script>

    var width = 2500,
        height = 1700,
        centered;

    // Define color scale
    var color = d3.scale.linear()
        .domain([1, 20])
        .clamp(true)
        .range(['#fff', '#000080']);

    var projection = d3.geo.mercator()
        .scale(65000)
        // Center the Map
        .center([-84, 33.7])
        .translate([width / 2, height / 2]);

    var path = d3.geo.path()
        .projection(projection);

    // Set svg width & height
    var svg = d3.select('svg')
        .attr('width', width)
        .attr('height', height);

    // Add background
    svg.append('rect')
            .attr('class', 'background')
            .attr('width', width)
            .attr('height', height)
            .on('click', clicked);

    var g = svg.append('g');

    var effectLayer = g.append('g')
        .classed('effect-layer', true);

    var mapLayer = g.append('g')
        .classed('map-layer', true);

    var dummyText = g.append('text')
        .classed('dummy-text', true)
        .attr('x', 10)
        .attr('y', 30)
        .style('opacity', 0);

    var bigText = g.append('text')
        .classed('big-text', true)
        .attr('x', 20)
        .attr('y', 45);

    var colorMap = new Map();



    tripData = d3.tsv('../data/2019_1.tsv', function (d) {
                        console.log(d);
                        d.forEach(function (d) {
                          if (d.sourceid === '141') {
                            var regionArr = d.dstid.split(', ');
                            regionArr.forEach(function (dd) {
                              colorMap.set(dd, d.color);
                            });
                          }
                        })
                      });
    //slider
    //load color data
    d3.select('#slider1').call(

            d3.slider().axis(true).min(1).max(12).step(1).snap(true)
                    .on("slide", function (evt, value) {
                      var tripData = d3.tsv('../data/2019_' + value + '.tsv', function (d) {
                        console.log(value);
                        d.forEach(function (d) {
                          if (d.sourceid === '141') {
                            var regionArr = d.dstid.split(', ');
                            regionArr.forEach(function (dd) {
                              colorMap.set(dd, d.color);
                            });
                          }
                        })
                      });
                      return tripData;

                    })
    );



        // Load map data
        d3.json('../data/atl.json', function (error, mapData) {
            var features = mapData.features;
            // Update color scale domain based on data
            color.domain([0, 20]);
            // Draw each province as a path
            mapLayer.selectAll('path')
                .data(features)
                .enter().append('path')
                .attr('d', path)
                .attr('vector-effect', 'non-scaling-stroke')
                .style('fill', fillFn)
                .on('mouseover', mouseover)
                .on('mouseout', mouseout)
                .on('click', clicked);
        });

        //Get color
        function fillFn(d) {
            var tmp = colorMap.get(d.properties.MOVEMENT_ID);
            if (tmp === '1') {
                return '#fffcdc';
            } else if (tmp === '2') {
                return '#c4f0a0';
            } else if (tmp === '3') {
                return '#8cd4bc';
            } else if (tmp === '4') {
                return '#55bcc4';
            } else if (tmp === '5') {
                return '#287cb4';
            } else {
                return '#2464ac';
            }
        }

        //change clicked region color and zoom in
        function clicked(d) {
            var x, y, k;

            // Compute centroid of the selected path
            if (d && centered !== d) {
                var centroid = path.centroid(d);
                x = centroid[0];
                y = centroid[1];
                k = 2;
                centered = d;
            } else {
                x = width / 2;
                y = height / 2;
                k = 1;
                centered = null;
            }

            // Highlight the clicked area
            mapLayer.selectAll('path')
                .style('fill', function (d) {
                    return centered && d === centered ? '#D5708B' : fillFn(d);
                });

            //Zoom
            g.transition()
                .duration(750)
                .attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')scale(' + k + ')translate(' + -x + ',' + -y + ')');
        }

        function mouseover(d) {
            // Highlight hovered area
            d3.select(this).style('fill', 'orange');
        }

        function mouseout(d) {
            // Reset color
            mapLayer.selectAll('path')
                .style('fill', function (d) {
                    return centered && d === centered ? '#D5708B' : fillFn(d);
                });

            // Remove effect text
            effectLayer.selectAll('text').transition()
                .style('opacity', 0)
                .remove();

            // Clear province name
            bigText.text('');

    }
</script>